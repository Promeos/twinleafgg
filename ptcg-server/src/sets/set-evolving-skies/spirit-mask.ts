// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { TrainerType } from '../../game/store/card/card-types';
import { StoreLike, State, GamePhase } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { AfterDamageEffect } from '../../game/store/effects/attack-effects';
import { IS_TOOL_BLOCKED } from '../../game/store/prefabs/prefabs';
import { StateUtils } from '../../game/store/state-utils';

export class SpiritMask extends TrainerCard {
  public trainerType: TrainerType = TrainerType.TOOL;
  public regulationMark: string = 'E';
  public set: string = 'EVS';
  public setNumber: string = '160';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Spirit Mask';
  public fullName: string = 'Spirit Mask EVS';
  public text: string = 'If the Pokémon this card is attached to is in the Active Spot and is damaged by an attack from your opponent\'s Pokémon (even if it is Knocked Out), your opponent discards a card from their hand. You may play any number of Item cards during your turn. Attach a Pokémon Tool to 1 of your Pokémon that doesn\'t already have a Pokémon Tool attached.';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ref: set-chilling-reign/rugged-helmet.ts (AfterDamageEffect tool pattern)
    if (effect instanceof AfterDamageEffect && effect.target.tools.includes(this)) {
      const player = effect.player;
      const targetPlayer = StateUtils.findOwner(state, effect.target);

      // Only triggers when tool-holder is damaged by opponent
      if (effect.damage <= 0 || player === targetPlayer) {
        return state;
      }

      // Only applies when the tool holder is in the Active Spot
      if (targetPlayer.active !== effect.target) {
        return state;
      }

      if (IS_TOOL_BLOCKED(store, state, targetPlayer, this)) {
        return state;
      }

      if (state.phase !== GamePhase.ATTACK) {
        return state;
      }

      // Opponent (the attacker) discards a random card from their hand
      if (player.hand.cards.length > 0) {
        const randomIndex = Math.floor(Math.random() * player.hand.cards.length);
        const randomCard = player.hand.cards[randomIndex];
        player.hand.moveCardTo(randomCard, player.discard);
      }
    }

    return state;
  }
}
