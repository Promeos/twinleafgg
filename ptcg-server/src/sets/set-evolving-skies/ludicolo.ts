// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { PlayerType, PowerType, StoreLike, State, StateUtils, GameMessage, ConfirmPrompt } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { DealDamageEffect } from '../../game/store/effects/attack-effects';
import { PlayPokemonEffect } from '../../game/store/effects/play-card-effects';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { IS_ABILITY_BLOCKED } from '../../game/store/prefabs/prefabs';

export class Ludicolo extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Lombre';
  public cardType: CardType = W;
  public hp: number = 140;
  public weakness = [{ type: L }];
  public retreat = [C, C];

  public readonly ENTHUSIASTIC_DANCE_MARKER = 'LUDICOLO_EVS_ENTHUSIASTIC_DANCE_MARKER';

  public powers = [{
    name: 'Enthusiastic Dance',
    powerType: PowerType.ABILITY,
    text: 'When you play this Pokémon from your hand to evolve 1 of your Pokémon during your turn, you may use this Ability. During this turn, your Basic Pokémon\'s attacks do 100 more damage to your opponent\'s Active Pokémon (before applying Weakness and Resistance).'
  }];

  public attacks = [
    {
      name: 'Wave Splash',
      cost: [W, C],
      damage: 120,
      text: ''
    }
  ];

  public regulationMark: string = 'E';
  public set: string = 'EVS';
  public setNumber: string = '34';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Ludicolo';
  public fullName: string = 'Ludicolo EVS';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Enthusiastic Dance (on-evolve activation)
    // When you play this Pokémon from your hand to evolve 1 of your Pokémon during your turn,
    // you may use this Ability. During this turn, your Basic Pokémon's attacks do 100 more damage.
    // Ref: set-silver-tempest/meowstic.ts (PlayPokemonEffect + ConfirmPrompt + marker pattern)
    if (effect instanceof PlayPokemonEffect && effect.pokemonCard === this) {
      const player = effect.player;

      // Check if ability is blocked
      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        return state;
      }

      state = store.prompt(state, new ConfirmPrompt(
        player.id,
        GameMessage.WANT_TO_USE_ABILITY,
      ), wantToUse => {
        if (wantToUse) {
          player.marker.addMarker(this.ENTHUSIASTIC_DANCE_MARKER, this);
        }
      });
    }

    // Passive: boost damage from your Basic Pokemon this turn
    if (effect instanceof DealDamageEffect) {
      const player = StateUtils.findOwner(state, effect.source);
      if (!player) return state;

      // Check if marker is active (Enthusiastic Dance was used this turn)
      if (!player.marker.hasMarker(this.ENTHUSIASTIC_DANCE_MARKER, this)) {
        return state;
      }

      // Make sure Ludicolo is in play and ability isn't blocked
      let ludicoloInPlay = false;
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList, card) => {
        if (card === this) ludicoloInPlay = true;
      });

      if (!ludicoloInPlay || IS_ABILITY_BLOCKED(store, state, player, this)) {
        return state;
      }

      // Only boost Basic Pokemon attacking opponent's active
      const attackerCard = effect.source.getPokemonCard();
      const opponent = StateUtils.getOpponent(state, player);
      if (attackerCard && attackerCard.stage === Stage.BASIC
        && effect.target === opponent.active) {
        effect.damage += 100;
      }
    }

    // Cleanup at end of turn
    if (effect instanceof EndTurnEffect) {
      effect.player.marker.removeMarker(this.ENTHUSIASTIC_DANCE_MARKER, this);
    }

    return state;
  }
}
