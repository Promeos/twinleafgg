// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { TrainerType, SuperType } from '../../game/store/card/card-types';
import { Card, CardList, ChooseCardsPrompt, GameMessage, ShowCardsPrompt, StoreLike, State, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { TrainerEffect } from '../../game/store/effects/play-card-effects';
import { SHUFFLE_DECK } from '../../game/store/prefabs/prefabs';

// Ref: set-silver-tempest/candice.ts (Look at top 7, reveal matching cards to hand, show to opponent, shuffle rest)
function* playCard(next: Function, store: StoreLike, state: State,
  self: Gordie, effect: TrainerEffect): IterableIterator<State> {
  const player = effect.player;
  const opponent = StateUtils.getOpponent(state, player);

  player.hand.moveCardTo(effect.trainerCard, player.supporter);
  effect.preventDefault = true;

  if (player.deck.cards.length === 0) {
    player.supporter.moveCardTo(effect.trainerCard, player.discard);
    return state;
  }

  // Take top 7 cards into a temp list
  const topCards = new CardList();
  const count = Math.min(7, player.deck.cards.length);
  player.deck.moveTo(topCards, count);

  // Block non-Energy cards so player can only select Energy
  const blocked: number[] = [];
  topCards.cards.forEach((c, index) => {
    if (c.superType !== SuperType.ENERGY) {
      blocked.push(index);
    }
  });

  let cards: Card[] = [];
  yield store.prompt(state, new ChooseCardsPrompt(
    player,
    GameMessage.CHOOSE_CARD_TO_HAND,
    topCards,
    { superType: SuperType.ENERGY },
    { min: 0, max: count, allowCancel: false, blocked }
  ), selected => {
    cards = selected || [];
    next();
  });

  // Move selected energy cards to hand, shuffle rest back into deck
  topCards.moveCardsTo(cards, player.hand);
  topCards.moveTo(player.deck);
  player.supporter.moveCardTo(effect.trainerCard, player.discard);

  // Reveal selected energy cards to opponent (card text says "reveal")
  if (cards.length > 0) {
    yield store.prompt(state, new ShowCardsPrompt(
      opponent.id,
      GameMessage.CARDS_SHOWED_BY_THE_OPPONENT,
      cards
    ), () => next());
  }

  return SHUFFLE_DECK(store, state, player);
}

export class Gordie extends TrainerCard {
  public trainerType: TrainerType = TrainerType.SUPPORTER;
  public regulationMark: string = 'E';
  public set: string = 'EVS';
  public setNumber: string = '149';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Gordie';
  public fullName: string = 'Gordie EVS';
  public text: string = 'Look at the top 7 cards of your deck. You may reveal any number of Energy cards you find there and put them into your hand. Shuffle the other cards back into your deck. You may play only 1 Supporter card during your turn.';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    if (effect instanceof TrainerEffect && effect.trainerCard === this) {
      const generator = playCard(() => generator.next(), store, state, this, effect);
      return generator.next().value;
    }

    return state;
  }
}
