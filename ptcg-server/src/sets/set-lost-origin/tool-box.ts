// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { TrainerType, SuperType } from '../../game/store/card/card-types';
import { StoreLike, State, GameMessage, CardList, ChooseCardsPrompt, ShowCardsPrompt, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { TrainerEffect } from '../../game/store/effects/play-card-effects';
import { SHUFFLE_DECK } from '../../game/store/prefabs/prefabs';

export class ToolBox extends TrainerCard {
  public trainerType: TrainerType = TrainerType.ITEM;
  public regulationMark: string = 'F';
  public set: string = 'LOR';
  public setNumber: string = '168';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Tool Box';
  public fullName: string = 'Tool Box (LOR 168)';
  public text: string = 'Look at the top 7 cards of your deck. You may reveal any number of PokÃ©mon Tool cards you find there and put them into your hand. Shuffle the other cards back into your deck. You may play any number of Item cards during your turn.';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ref: set-astral-radiance/energy-loto.ts (deckTop pattern - look at top N, choose cards to hand, shuffle rest)
    // Ref: set-team-up/jirachi.ts (filter to specific trainer type using blocked array)
    if (effect instanceof TrainerEffect && effect.trainerCard === this) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      effect.preventDefault = true;

      const deckTop = new CardList();
      const count = Math.min(7, player.deck.cards.length);
      player.deck.moveTo(deckTop, count);

      // Find Tool cards in top 7 and build blocked array for non-Tool cards
      const blocked: number[] = [];
      deckTop.cards.forEach((card, index) => {
        const isTool = card instanceof TrainerCard && card.trainerType === TrainerType.TOOL;
        if (!isTool) {
          blocked.push(index);
        }
      });

      const toolCards = deckTop.cards.filter(
        c => c instanceof TrainerCard && c.trainerType === TrainerType.TOOL
      );

      if (toolCards.length === 0) {
        // No Tool cards found, shuffle all cards back into deck
        deckTop.moveTo(player.deck);
        return SHUFFLE_DECK(store, state, player);
      }

      return store.prompt(state, new ChooseCardsPrompt(
        player,
        GameMessage.CHOOSE_CARD_TO_HAND,
        deckTop,
        { superType: SuperType.TRAINER },
        { min: 0, max: toolCards.length, allowCancel: false, blocked }
      ), selected => {
        const cards = selected || [];

        if (cards.length > 0) {
          // Reveal selected Tool cards to opponent
          store.prompt(state, new ShowCardsPrompt(
            opponent.id,
            GameMessage.CARDS_SHOWED_BY_THE_OPPONENT,
            cards
          ), () => { });

          // Move chosen Tool cards to hand
          deckTop.moveCardsTo(cards, player.hand);
        }

        // Shuffle remaining cards back into deck
        deckTop.moveTo(player.deck);
        SHUFFLE_DECK(store, state, player);
      });
    }

    return state;
  }
}
