// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { StoreLike, State, StateUtils } from '../../game';
import { DealDamageEffect } from '../../game/store/effects/attack-effects';
import { Effect } from '../../game/store/effects/effect';
import { KnockOutEffect } from '../../game/store/effects/game-effects';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { WAS_ATTACK_USED, REMOVE_MARKER_AT_END_OF_TURN, REPLACE_MARKER_AT_END_OF_TURN } from '../../game/store/prefabs/prefabs';

export class Sandile2 extends PokemonCard {
  public stage: Stage = Stage.BASIC;
  public cardType: CardType = D;
  public hp: number = 70;
  public weakness = [{ type: F }];
  public resistance = [{ type: P, value: -20 }];
  public retreat = [C, C];

  public readonly GRANDIOSE_MARKER = 'SANDILE2_UNB_GRANDIOSE_MARKER';
  public readonly CLEAR_GRANDIOSE_MARKER = 'SANDILE2_UNB_CLEAR_GRANDIOSE_MARKER';

  public usedGrandiose = false;

  public attacks = [
    {
      name: 'Grandiose Fangs',
      cost: [C, C, C],
      damage: 30,
      text: 'If your opponent\'s Pokémon is Knocked Out by damage from this attack, this Pokémon\'s attacks do 120 more damage to your opponent\'s Active Pokémon during your next turn (before applying Weakness and Resistance).'
    }
  ];

  public set: string = 'UNB';
  public setNumber: string = '114';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Sandile';
  public fullName: string = 'Sandile UNB 114';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Grandiose Fangs
    // Ref: set-ultra-prism/spiritomb.ts (conditional marker)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      this.usedGrandiose = true;
    }

    // Check if KO happened from this attack
    if (effect instanceof KnockOutEffect && this.usedGrandiose) {
      const cardOwner = StateUtils.findOwner(state, StateUtils.findCardList(state, this));
      // If the KO'd pokemon's owner is the opponent of this card's owner
      if (effect.player !== cardOwner) {
        cardOwner.marker.addMarker(this.GRANDIOSE_MARKER, this);
      }
    }

    // Apply bonus damage during next turn
    if (effect instanceof DealDamageEffect && effect.source.cards.includes(this)
      && effect.source.getPokemonCard() === this) {
      const player = StateUtils.findOwner(state, effect.source);
      if (player.marker.hasMarker(this.GRANDIOSE_MARKER, this) ||
          player.marker.hasMarker(this.CLEAR_GRANDIOSE_MARKER, this)) {
        effect.damage += 120;
      }
    }

    // 2-phase cleanup
    if (effect instanceof EndTurnEffect) {
      this.usedGrandiose = false;
      REMOVE_MARKER_AT_END_OF_TURN(effect, this.CLEAR_GRANDIOSE_MARKER, this);
      REPLACE_MARKER_AT_END_OF_TURN(effect, this.GRANDIOSE_MARKER, this.CLEAR_GRANDIOSE_MARKER, this);
    }

    return state;
  }
}
