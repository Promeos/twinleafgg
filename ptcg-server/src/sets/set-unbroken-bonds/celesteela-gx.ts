// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag, SuperType } from '../../game/store/card/card-types';
import { PowerType, PlayerType, StoreLike, State, StateUtils, AttachEnergyPrompt, SlotType, GameMessage } from '../../game';
import { AbstractAttackEffect } from '../../game/store/effects/attack-effects';
import { Effect } from '../../game/store/effects/effect';
import { WAS_ATTACK_USED, IS_ABILITY_BLOCKED, BLOCK_IF_GX_ATTACK_USED } from '../../game/store/prefabs/prefabs';

export class CelesteelaGx extends PokemonCard {
  public tags = [CardTag.POKEMON_GX, CardTag.ULTRA_BEAST];
  public stage: Stage = Stage.BASIC;
  public cardType: CardType = C;
  public hp: number = 200;
  public weakness = [{ type: L }];
  public resistance = [{ type: F, value: -20 }];
  public retreat = [C, C, C, C];

  public powers = [{
    name: 'Force Canceler',
    powerType: PowerType.ABILITY,
    text: 'As long as this Pokémon is your Active Pokémon, prevent all effects of your opponent\'s GX attacks, including damage, done to your Pokémon.'
  }];

  public attacks = [
    {
      name: 'Power Cyclone',
      cost: [C, C, C],
      damage: 110,
      text: 'Move an Energy from this Pokémon to 1 of your Benched Pokémon.'
    },
    {
      name: 'Discovery-GX',
      cost: [C],
      damage: 0,
      text: 'Count your Prize cards and put them into your hand. Then, take that many cards from the top of your deck and put them face down as your Prize cards. If you don\'t have that many cards in your deck, this attack does nothing. (You can\'t use more than 1 GX attack in a game.)'
    }
  ];

  public set: string = 'UNB';
  public setNumber: string = '163';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Celesteela-GX';
  public fullName: string = 'Celesteela-GX UNB';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Force Canceler (passive - prevent GX attack effects while active)
    // Ref: set-team-up/latias-and-latios-gx.ts (Aero Unit-GX - AbstractAttackEffect prevention), set-cosmic-eclipse/alolan-persian-gx.ts (Smug Face)
    if (effect instanceof AbstractAttackEffect) {
      // Check if the attack is a GX attack
      if (!effect.attack || !effect.attack.name.includes('-GX')) {
        return state;
      }

      // Check if the target belongs to Celesteela's owner
      const targetOwner = StateUtils.findOwner(state, effect.target);

      // Check if Celesteela is this owner's active Pokemon
      if (targetOwner.active.getPokemonCard() !== this) {
        return state;
      }

      // Check if the attacker is the opponent
      const sourceOwner = StateUtils.findOwner(state, effect.source);
      if (targetOwner === sourceOwner) {
        return state;
      }

      if (IS_ABILITY_BLOCKED(store, state, targetOwner, this)) {
        return state;
      }

      effect.preventDefault = true;
      return state;
    }

    // Attack 1: Power Cyclone
    // Ref: set-x-and-y/yveltal-ex.ts (Y Cyclone - move energy to bench)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const hasBench = player.bench.some(b => b.cards.length > 0);

      if (hasBench) {
        store.prompt(state, new AttachEnergyPrompt(
          player.id,
          GameMessage.ATTACH_ENERGY_TO_BENCH,
          player.active,
          PlayerType.BOTTOM_PLAYER,
          [SlotType.BENCH],
          { superType: SuperType.ENERGY },
          { allowCancel: false, min: 1, max: 1 }
        ), transfers => {
          transfers = transfers || [];
          for (const transfer of transfers) {
            const target = StateUtils.getTarget(state, player, transfer.to);
            player.active.moveCardTo(transfer.card, target);
          }
        });
      }
    }

    // Attack 2: Discovery-GX
    // Ref: set-ultra-prism/celesteela-gx.ts (Blaster-GX - GX attack with prize interaction)
    if (WAS_ATTACK_USED(effect, 1, this)) {
      const player = effect.player;

      BLOCK_IF_GX_ATTACK_USED(player);

      // Count prize cards remaining
      const prizeCount = player.prizes.filter(p => p.cards.length > 0).length;

      // If not enough cards in deck, does nothing
      if (player.deck.cards.length < prizeCount) {
        player.usedGX = true;
        return state;
      }

      player.usedGX = true;

      // Put all prize cards into hand
      player.prizes.forEach(prizeList => {
        if (prizeList.cards.length > 0) {
          prizeList.moveTo(player.hand);
        }
      });

      // Take that many cards from top of deck as new prize cards
      let placed = 0;
      for (let i = 0; i < player.prizes.length && placed < prizeCount; i++) {
        if (player.prizes[i].cards.length === 0 && player.deck.cards.length > 0) {
          player.deck.moveTo(player.prizes[i], 1);
          player.prizes[i].isSecret = true;
          player.prizes[i].isPublic = false;
          placed++;
        }
      }
    }

    return state;
  }
}
