// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag } from '../../game/store/card/card-types';
import { StoreLike, State, StateUtils, PlayerType } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { DealDamageEffect, PutDamageEffect } from '../../game/store/effects/attack-effects';
import { TrainerEffect } from '../../game/store/effects/play-card-effects';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { WAS_ATTACK_USED, BLOCK_IF_GX_ATTACK_USED, DRAW_CARDS, SHUFFLE_DECK, ADD_MARKER, HAS_MARKER, REMOVE_MARKER } from '../../game/store/prefabs/prefabs';

export class VenomothGx extends PokemonCard {
  public tags = [CardTag.POKEMON_GX];
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Venonat';
  public cardType: CardType = G;
  public hp: number = 200;
  public weakness = [{ type: R }];
  public retreat = [C];

  public attacks = [
    {
      name: 'Shinobi Mastery',
      cost: [G, C, C],
      damage: 110,
      damageCalculation: '+' as '+',
      text: 'If you played Koga\'s Trap from your hand during this turn, this attack does 90 more damage. If you played Janine from your hand during this turn, prevent all damage done to this Pokémon by attacks from Basic Pokémon during your opponent\'s next turn.'
    },
    {
      name: 'Ten-Card Return-GX',
      cost: [C],
      damage: 60,
      text: 'Shuffle your hand into your deck. Then, draw 10 cards. (You can\'t use more than 1 GX attack in a game.)'
    }
  ];

  public set: string = 'UNB';
  public setNumber: string = '12';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Venomoth-GX';
  public fullName: string = 'Venomoth-GX UNB';

  public readonly KOGAS_TRAP_MARKER = 'VENOMOTH_GX_KOGAS_TRAP_MARKER';
  public readonly JANINE_MARKER = 'VENOMOTH_GX_JANINE_MARKER';
  public readonly PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER = 'VENOMOTH_GX_PREVENT_DAMAGE_FROM_BASIC_MARKER';
  public readonly CLEAR_PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER = 'VENOMOTH_GX_CLEAR_PREVENT_DAMAGE_FROM_BASIC_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Track if Koga's Trap or Janine was played this turn
    // Ref: set-ultra-prism/garchomp.ts (Royal Blades - track specific supporter played)
    if (effect instanceof TrainerEffect && effect.trainerCard.name === 'Koga\'s Trap') {
      const player = effect.player;
      ADD_MARKER(this.KOGAS_TRAP_MARKER, player, this);
    }

    if (effect instanceof TrainerEffect && effect.trainerCard.name === 'Janine') {
      const player = effect.player;
      ADD_MARKER(this.JANINE_MARKER, player, this);
    }

    // Cleanup markers at end of turn
    if (effect instanceof EndTurnEffect) {
      if (HAS_MARKER(this.KOGAS_TRAP_MARKER, effect.player, this)) {
        REMOVE_MARKER(this.KOGAS_TRAP_MARKER, effect.player, this);
      }
      if (HAS_MARKER(this.JANINE_MARKER, effect.player, this)) {
        REMOVE_MARKER(this.JANINE_MARKER, effect.player, this);
      }

      // Cleanup prevent damage markers
      if (effect.player.marker.hasMarker(this.CLEAR_PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER, this)) {
        effect.player.marker.removeMarker(this.CLEAR_PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER, this);
        const opponent = StateUtils.getOpponent(state, effect.player);
        opponent.forEachPokemon(PlayerType.TOP_PLAYER, (cardList) => {
          cardList.marker.removeMarker(this.PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER, this);
        });
      }
    }

    // Attack 1: Shinobi Mastery
    // Refs: set-ultra-prism/garchomp.ts (supporter tracking), set-stellar-crown/dipplin.ts (prevent damage from Basic)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      // If Koga's Trap was played this turn, do 90 more damage
      if (HAS_MARKER(this.KOGAS_TRAP_MARKER, player, this)) {
        effect.damage += 90;
      }

      // If Janine was played this turn, prevent damage from Basic Pokemon during opponent's next turn
      if (HAS_MARKER(this.JANINE_MARKER, player, this)) {
        player.active.marker.addMarker(this.PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER, this);
        opponent.marker.addMarker(this.CLEAR_PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER, this);
      }
    }

    // Intercept damage from Basic Pokemon
    // Ref: set-stellar-crown/dipplin.ts (prevent damage from Basic Pokemon)
    if (effect instanceof DealDamageEffect
      && effect.target.marker.hasMarker(this.PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER, this)) {
      const card = effect.source.getPokemonCard();
      if (card && card.stage === Stage.BASIC) {
        effect.damage = 0;
      }
    }

    if (effect instanceof PutDamageEffect
      && effect.target.marker.hasMarker(this.PREVENT_DAMAGE_FROM_BASIC_POKEMON_MARKER, this)) {
      const card = effect.source.getPokemonCard();
      if (card && card.stage === Stage.BASIC) {
        effect.preventDefault = true;
      }
    }

    // Attack 2: Ten-Card Return-GX
    // Ref: set-celestial-storm/plusle.ts (shuffle hand + draw)
    if (WAS_ATTACK_USED(effect, 1, this)) {
      const player = effect.player;

      BLOCK_IF_GX_ATTACK_USED(player);
      player.usedGX = true;

      // Shuffle hand into deck
      const cards = player.hand.cards.slice();
      cards.forEach(c => {
        player.hand.moveCardTo(c, player.deck);
      });
      SHUFFLE_DECK(store, state, player);

      // Draw 10 cards
      DRAW_CARDS(player, 10);
    }

    return state;
  }
}
