// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag, BoardEffect } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, StateUtils, PlayerType } from '../../game';
import { DealDamageEffect } from '../../game/store/effects/attack-effects';
import { Effect } from '../../game/store/effects/effect';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { WAS_ATTACK_USED, WAS_POWER_USED, IS_ABILITY_BLOCKED, ADD_MARKER, HAS_MARKER, REMOVE_MARKER } from '../../game/store/prefabs/prefabs';
import { GameError, GameMessage } from '../../game';
import { GamePhase } from '../../game/store/state/state';

export class ZamazentaVstar extends PokemonCard {
  public tags = [CardTag.POKEMON_VSTAR];
  public stage: Stage = Stage.VSTAR;
  public evolvesFrom: string = 'Zamazenta V';
  public cardType: CardType = M;
  public hp: number = 270;
  public weakness = [{ type: R }];
  public resistance = [{ type: G, value: -30 }];
  public retreat = [C, C];

  public readonly SHIELD_STAR_REDUCE_MARKER = 'ZAMAZENTA_VSTAR_SHIELD_STAR_REDUCE_MARKER';
  public readonly SHIELD_STAR_CLEAR_MARKER = 'ZAMAZENTA_VSTAR_SHIELD_STAR_CLEAR_MARKER';

  public powers = [  {
    name: 'Shield Star',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'During your turn, you may use this Ability. During your opponent\'s next turn, all of your Pokémon take 100 less damage from attacks from your opponent\'s Pokémon (after applying Weakness and Resistance). (This includes Pokémon that come into play during this turn or during your opponent\'s next turn.) (You can\'t use more than 1 VSTAR Power in a game.)'
  }];

  public attacks = [
    {
      name: 'Giga Impact',
      cost: [M, M, C],
      damage: 220,
      text: 'During your next turn, this Pokémon can\'t attack.'
    }
  ];

  public regulationMark: string = 'F';
  public set: string = 'CRZ';
  public setNumber: string = '99';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Zamazenta VSTAR';
  public fullName: string = 'Zamazenta VSTAR (CRZ 99)';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Shield Star (VSTAR Power)
    // Ref: set-silver-tempest/mawile-vstar.ts (VSTAR Power pattern with usedVSTAR)
    // Ref: set-sword-and-shield/corviknight.ts (DealDamageEffect marker pattern for 100 less damage)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        throw new GameError(GameMessage.BLOCKED_BY_EFFECT);
      }

      if (player.usedVSTAR === true) {
        throw new GameError(GameMessage.LABEL_VSTAR_USED);
      }

      player.usedVSTAR = true;

      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList, card) => {
        if (card === this) {
          cardList.addBoardEffect(BoardEffect.ABILITY_USED);
        }
      });

      // Mark all current player's Pokemon AND track via a player-level clear marker
      ADD_MARKER(this.SHIELD_STAR_CLEAR_MARKER, opponent, this);

      // Mark all of the player's Pokemon currently in play
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList) => {
        ADD_MARKER(this.SHIELD_STAR_REDUCE_MARKER, cardList, this);
      });
    }

    // Reduce damage by 100 for all of the player's Pokemon with the reduce marker
    // Also apply to newly played Pokemon during the opponent's turn
    if (effect instanceof DealDamageEffect && state.phase === GamePhase.ATTACK) {
      const player = StateUtils.findOwner(state, effect.target);
      const attacker = StateUtils.findOwner(state, effect.source);

      if (player === attacker) {
        return state;
      }

      // Check if attacker has the clear marker (meaning it's the opponent's turn and Shield Star is active)
      if (HAS_MARKER(this.SHIELD_STAR_CLEAR_MARKER, attacker, this)) {
        // Apply to target if it has the reduce marker, or apply globally to all player's Pokemon
        // The card text says "(This includes Pokémon that come into play during this turn or during your opponent's next turn.)"
        // So we apply reduction to all of the defending player's Pokemon
        effect.damage = Math.max(0, effect.damage - 100);
      }
    }

    // Cleanup at end of opponent's turn
    if (effect instanceof EndTurnEffect && HAS_MARKER(this.SHIELD_STAR_CLEAR_MARKER, effect.player, this)) {
      REMOVE_MARKER(this.SHIELD_STAR_CLEAR_MARKER, effect.player, this);
      const opponent = StateUtils.getOpponent(state, effect.player);
      opponent.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList) => {
        cardList.marker.removeMarker(this.SHIELD_STAR_REDUCE_MARKER, this);
      });
    }

    // Attack 1: Giga Impact
    // Ref: set-brilliant-stars/zacian-v.ts (cannotAttackNextTurnPending pattern - "can't attack next turn")
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      player.active.cannotAttackNextTurnPending = true;
    }

    return state;
  }
}
