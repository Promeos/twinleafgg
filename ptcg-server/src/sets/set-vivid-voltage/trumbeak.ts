// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, EnergyType, SuperType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, StateUtils, GameMessage, ConfirmPrompt, CardList, AttachEnergyPrompt, PlayerType, SlotType } from '../../game';
import { EnergyCard } from '../../game/store/card/energy-card';
import { Effect } from '../../game/store/effects/effect';
import { AttachEnergyEffect } from '../../game/store/effects/play-card-effects';
import { IS_ABILITY_BLOCKED, JUST_EVOLVED, SHUFFLE_DECK } from '../../game/store/prefabs/prefabs';

export class Trumbeak extends PokemonCard {
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Pikipek';
  public cardType: CardType = C;
  public hp: number = 80;
  public weakness = [{ type: L }];
  public resistance = [{ type: F, value: -30 }];
  public retreat = [C];

  public powers = [  {
    name: 'Charging Trumpet',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'When you play this Pokémon from your hand to evolve 1 of your Pokémon during your turn, you may look at the top 3 cards of your deck and attach any number of basic Energy cards you find there to your Pokémon in any way you like. Shuffle the other cards back into your deck.'
  }];

  public attacks = [
    {
      name: 'Drill Peck',
      cost: [C, C, C],
      damage: 50,
      text: ''
    }
  ];

  public regulationMark: string = 'D';
  public set: string = 'VIV';
  public setNumber: string = '144';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Trumbeak';
  public fullName: string = 'Trumbeak VIV';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Charging Trumpet (on-evolve - look top 3, attach any basic Energy to any Pokemon)
    // Ref: set-unbroken-bonds/sharpedo.ts (JUST_EVOLVED + ConfirmPrompt + CardList top deck + find Energy),
    //      set-legends-awakened/regigigas.ts (AttachEnergyPrompt to attach from temp list)
    if (JUST_EVOLVED(effect, this)) {
      const player = effect.player;

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        return state;
      }

      if (player.deck.cards.length === 0) {
        return state;
      }

      store.prompt(state, new ConfirmPrompt(
        player.id,
        GameMessage.WANT_TO_USE_ABILITY,
      ), wantToUse => {
        if (!wantToUse) {
          return;
        }

        const topCards = new CardList();
        const count = Math.min(3, player.deck.cards.length);
        player.deck.moveTo(topCards, count);

        // Find basic Energy cards in top 3
        const basicEnergyCards = topCards.cards.filter(c =>
          c instanceof EnergyCard && c.energyType === EnergyType.BASIC
        );

        if (basicEnergyCards.length === 0) {
          // No energy found, shuffle back
          topCards.moveTo(player.deck);
          SHUFFLE_DECK(store, state, player);
          return;
        }

        // Let player choose which energy to attach and to which Pokemon
        store.prompt(state, new AttachEnergyPrompt(
          player.id,
          GameMessage.ATTACH_ENERGY_CARDS,
          topCards,
          PlayerType.BOTTOM_PLAYER,
          [SlotType.ACTIVE, SlotType.BENCH],
          { superType: SuperType.ENERGY, energyType: EnergyType.BASIC },
          { allowCancel: false, min: 0, max: basicEnergyCards.length }
        ), transfers => {
          transfers = transfers || [];
          for (const transfer of transfers) {
            const target = StateUtils.getTarget(state, player, transfer.to);
            const energyCard = transfer.card as EnergyCard;
            const attachEnergyEffect = new AttachEnergyEffect(player, energyCard, target);
            store.reduceEffect(state, attachEnergyEffect);
          }

          // Shuffle remaining cards back into deck
          topCards.moveTo(player.deck);
          SHUFFLE_DECK(store, state, player);
        });
      });

      return state;
    }

    return state;
  }
}
