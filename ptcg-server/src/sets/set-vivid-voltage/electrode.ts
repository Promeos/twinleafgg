// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, SuperType, EnergyType } from '../../game/store/card/card-types';
import { AttachEnergyPrompt, GameError, GameMessage, PlayerType, PowerType, SlotType, StoreLike, State, StateUtils } from '../../game';
import { CardTarget } from '../../game/store/actions/play-card-action';
import { Effect } from '../../game/store/effects/effect';
import { WAS_POWER_USED, SHUFFLE_DECK, IS_ABILITY_BLOCKED } from '../../game/store/prefabs/prefabs';
import { KnockOutEffect } from '../../game/store/effects/game-effects';

export class Electrode extends PokemonCard {
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Voltorb';
  public cardType: CardType = L;
  public hp: number = 90;
  public weakness = [{ type: F }];
  public retreat = [C];

  public powers = [  {
    name: 'Buzzap Generator',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'Once during your turn, if this Pokémon is on your Bench, you may search your deck for up to 2 [L] Energy cards and attach them to your Lightning Pokémon in any way you like. Then, shuffle your deck. If you searched your deck in this way, this Pokémon is Knocked Out.'
  }];

  public attacks = [
    {
      name: 'Electric Ball',
      cost: [L, L, C],
      damage: 100,
      text: ''
    }
  ];

  public regulationMark: string = 'D';
  public set: string = 'VIV';
  public setNumber: string = '46';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Electrode';
  public fullName: string = 'Electrode VIV';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Buzzap Generator
    // Ref: set-paradox-rift/iron-moth.ts (bench ability triggered with WAS_POWER_USED)
    // Ref: set-vivid-voltage/dialga.ts (AttachEnergyPrompt + shuffle deck)
    // Ref: set-vivid-voltage/forretress.ts (KnockOutEffect on self)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        throw new GameError(GameMessage.BLOCKED_BY_EFFECT);
      }

      // Must be on bench, not active
      const isBenched = player.bench.some(b => b.getPokemonCard() === this);
      if (!isBenched) {
        return state;
      }

      // Block non-Lightning Pokemon slots
      const blockedTo: CardTarget[] = [];
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList, card, target) => {
        if (card.cardType !== CardType.LIGHTNING) {
          blockedTo.push(target);
        }
      });

      return store.prompt(state, new AttachEnergyPrompt(
        player.id,
        GameMessage.ATTACH_ENERGY_CARDS,
        player.deck,
        PlayerType.BOTTOM_PLAYER,
        [SlotType.ACTIVE, SlotType.BENCH],
        { superType: SuperType.ENERGY, energyType: EnergyType.BASIC, name: 'Lightning Energy' },
        { allowCancel: false, min: 0, max: 2, blockedTo }
      ), transfers => {
        transfers = transfers || [];

        for (const transfer of transfers) {
          const target = StateUtils.getTarget(state, player, transfer.to);
          player.deck.moveCardTo(transfer.card, target);
        }

        SHUFFLE_DECK(store, state, player);

        // KO this Electrode - the ability text says "If you searched your deck in this way,
        // this Pokemon is Knocked Out", which applies whenever the ability is used
        const electrodeList = player.bench.find(b => b.getPokemonCard() === this);
        if (electrodeList) {
          const opponent = StateUtils.getOpponent(state, player);
          const knockOutEffect = new KnockOutEffect(opponent, electrodeList);
          store.reduceEffect(state, knockOutEffect);
        }
      });
    }

    return state;
  }
}
