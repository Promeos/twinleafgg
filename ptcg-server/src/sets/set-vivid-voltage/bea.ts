// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { CardType, SuperType, TrainerType } from '../../game/store/card/card-types';
import { CardTarget, PlayerType, SlotType } from '../../game/store/actions/play-card-action';
import { GameMessage, StoreLike, State } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { AttachEnergyEffect, TrainerEffect } from '../../game/store/effects/play-card-effects';
import { EnergyCard } from '../../game/store/card/energy-card';
import { AttachEnergyPrompt } from '../../game/store/prompts/attach-energy-prompt';
import { CardList } from '../../game/store/state/card-list';
import { StateUtils } from '../../game/store/state-utils';

export class Bea extends TrainerCard {
  public trainerType: TrainerType = TrainerType.SUPPORTER;
  public regulationMark: string = 'D';
  public set: string = 'VIV';
  public setNumber: string = '147';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Bea';
  public fullName: string = 'Bea VIV';
  public text: string = 'Discard the top 5 cards of your deck, and attach any Energy cards you discarded in this way to your Benched Fighting Pok√©mon in any way you like. You may play only 1 Supporter card during your turn.';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ref: set-pokemon-go/gyarados.ts (MOVE_CARDS top 5), set-darkness-ablaze/turbo-patch.ts (AttachEnergyPrompt to bench)
    if (effect instanceof TrainerEffect && effect.trainerCard === this) {
      const player = effect.player;

      effect.preventDefault = true;
      player.hand.moveCardTo(this, player.supporter);

      // Discard top 5 cards from deck into a temp list to find energy cards
      const discarded = new CardList();
      const count = Math.min(5, player.deck.cards.length);

      for (let i = 0; i < count; i++) {
        if (player.deck.cards.length > 0) {
          player.deck.moveCardTo(player.deck.cards[0], discarded);
        }
      }

      // Find energy cards among the discarded
      const energyCards = discarded.cards.filter(c => c instanceof EnergyCard) as EnergyCard[];
      const nonEnergyCards = discarded.cards.filter(c => !(c instanceof EnergyCard));

      // Discard non-energy cards
      nonEnergyCards.forEach(c => discarded.moveCardTo(c, player.discard));

      if (energyCards.length === 0) {
        // No energy found, just discard trainer
        player.supporter.moveCardTo(this, player.discard);
        return state;
      }

      // Check if there are Benched Fighting Pokemon to attach to
      const blockedTo: CardTarget[] = [];
      let hasFightingBenched = false;

      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList, card, target) => {
        // Only allow benched Pokemon - not the active
        if (player.active === cardList) {
          blockedTo.push(target);
          return;
        }
        if (cardList.cards.length === 0) {
          blockedTo.push(target);
          return;
        }
        const pokemon = cardList.getPokemonCard();
        if (!pokemon || pokemon.cardType !== CardType.FIGHTING) {
          blockedTo.push(target);
          return;
        }
        hasFightingBenched = true;
      });

      if (!hasFightingBenched) {
        // No valid targets - discard the energy cards too
        energyCards.forEach(c => discarded.moveCardTo(c, player.discard));
        player.supporter.moveCardTo(this, player.discard);
        return state;
      }

      return store.prompt(state, new AttachEnergyPrompt(
        player.id,
        GameMessage.ATTACH_ENERGY_CARDS,
        discarded,
        PlayerType.BOTTOM_PLAYER,
        [SlotType.BENCH],
        { superType: SuperType.ENERGY },
        { allowCancel: false, min: 0, max: energyCards.length, blockedTo }
      ), transfers => {
        transfers = transfers || [];

        for (const transfer of transfers) {
          const target = StateUtils.getTarget(state, player, transfer.to);
          const energyCard = transfer.card as EnergyCard;
          const attachEnergyEffect = new AttachEnergyEffect(player, energyCard, target);
          store.reduceEffect(state, attachEnergyEffect);
        }

        // Discard remaining energy cards that weren't attached
        discarded.cards.slice().forEach(c => discarded.moveCardTo(c, player.discard));

        player.supporter.moveCardTo(this, player.discard);
      });
    }

    return state;
  }
}
