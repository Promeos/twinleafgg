// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { CheckProvidedEnergyEffect } from '../../game/store/effects/check-effects';
import { WAS_ATTACK_USED, IS_ABILITY_BLOCKED, ON_DAMAGED_BY_OPPONENT_ATTACK_EVEN_IF_KNOCKED_OUT } from '../../game/store/prefabs/prefabs';

export class GalarianRunerigus extends PokemonCard {
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Galarian Yamask';
  public cardType: CardType = F;
  public hp: number = 120;
  public weakness = [{ type: G }];
  public retreat = [C, C];

  public powers = [{
    name: 'Spiteful Slate',
    powerType: PowerType.ABILITY,
    text: 'If this Pokémon is in the Active Spot and is damaged by an attack from your opponent\'s Pokémon VMAX (even if this Pokémon is Knocked Out), put damage counters on the Attacking Pokémon equal to the damage done to this Pokémon.'
  }];

  public attacks = [
    {
      name: 'Energy Press',
      cost: [C, C, C],
      damage: 60,
      damageCalculation: '+' as '+',
      text: 'This attack does 20 more damage for each Energy attached to your opponent\'s Active Pokémon.'
    }
  ];

  public regulationMark: string = 'E';
  public set: string = 'CRE';
  public setNumber: string = '83';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Galarian Runerigus';
  public fullName: string = 'Galarian Runerigus CRE';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Spiteful Slate
    // Ref: set-flashfire/qwilfish.ts (ON_DAMAGED_BY_OPPONENT_ATTACK_EVEN_IF_KNOCKED_OUT - retaliatory damage)
    if (ON_DAMAGED_BY_OPPONENT_ATTACK_EVEN_IF_KNOCKED_OUT(state, effect, { source: this })) {
      const targetPlayer = StateUtils.findOwner(state, effect.target);

      if (IS_ABILITY_BLOCKED(store, state, targetPlayer, this)) {
        return state;
      }

      // Only trigger if the attacking Pokemon is a VMAX
      const attackerCard = effect.source.getPokemonCard();
      if (!attackerCard || !attackerCard.tags.includes(CardTag.POKEMON_VMAX)) {
        return state;
      }

      // Put damage counters equal to damage done (effect.damage is the actual damage dealt)
      effect.source.damage += effect.damage;
    }

    // Attack 1: Energy Press
    // Ref: set-chilling-reign/hatterene.ts (Psychic - CheckProvidedEnergyEffect to count energies)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      const checkEnergy = new CheckProvidedEnergyEffect(opponent, opponent.active);
      store.reduceEffect(state, checkEnergy);
      const energyCount = checkEnergy.energyMap.reduce((sum, em) => sum + em.provides.length, 0);
      effect.damage += 20 * energyCount;
    }

    return state;
  }
}
