// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, CardTag } from '../../game/store/card/card-types';
import { StoreLike, State, StateUtils, PlayerType } from '../../game';
import { AbstractAttackEffect } from '../../game/store/effects/attack-effects';
import { Effect } from '../../game/store/effects/effect';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { WAS_ATTACK_USED, MULTIPLE_COIN_FLIPS_PROMPT } from '../../game/store/prefabs/prefabs';

export class Dugtrio extends PokemonCard {
  public tags = [CardTag.RAPID_STRIKE];
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Diglett';
  public cardType: CardType = F;
  public hp: number = 90;
  public weakness = [{ type: G }];
  public retreat = [C];

  public readonly PREVENT_MARKER = 'DUGTRIO_CRE_PREVENT_MARKER';
  public readonly CLEAR_PREVENT_MARKER = 'DUGTRIO_CRE_CLEAR_PREVENT_MARKER';

  public attacks = [
    {
      name: 'Triple Heads',
      cost: [F, C],
      damage: 60,
      damageCalculation: 'x' as 'x',
      text: 'Flip 3 coins. This attack does 60 damage for each heads. If all of them are heads, during your opponent\'s next turn, prevent all damage from and effects of attacks done to this PokÃ©mon.'
    }
  ];

  public regulationMark: string = 'E';
  public set: string = 'CRE';
  public setNumber: string = '77';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Dugtrio';
  public fullName: string = 'Dugtrio CRE';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Triple Heads
    // Ref: set-unbroken-bonds/goldeen.ts (coin flip prevent next turn attacks via AbstractAttackEffect),
    //      set-champions-path/malamar.ts (MULTIPLE_COIN_FLIPS_PROMPT for damage per heads)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);
      MULTIPLE_COIN_FLIPS_PROMPT(store, state, player, 3, results => {
        const heads = results.filter(r => r).length;
        effect.damage = 60 * heads;

        if (heads === 3) {
          player.active.marker.addMarker(this.PREVENT_MARKER, this);
          opponent.marker.addMarker(this.CLEAR_PREVENT_MARKER, this);
        }
      });
    }

    if (effect instanceof AbstractAttackEffect
      && effect.target.marker.hasMarker(this.PREVENT_MARKER, this)) {
      effect.preventDefault = true;
      return state;
    }

    if (effect instanceof EndTurnEffect
      && effect.player.marker.hasMarker(this.CLEAR_PREVENT_MARKER, this)) {
      effect.player.marker.removeMarker(this.CLEAR_PREVENT_MARKER, this);
      const opponent = StateUtils.getOpponent(state, effect.player);
      opponent.forEachPokemon(PlayerType.TOP_PLAYER, (cardList) => {
        cardList.marker.removeMarker(this.PREVENT_MARKER, this);
      });
    }

    return state;
  }
}
