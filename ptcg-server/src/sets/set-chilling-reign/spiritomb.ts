// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { DamageMap, GameMessage, PlayerType, PutDamagePrompt, SlotType, StoreLike, State, StateUtils } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { PutCountersEffect } from '../../game/store/effects/attack-effects';
import { WAS_ATTACK_USED, SHUFFLE_DECK } from '../../game/store/prefabs/prefabs';

export class Spiritomb extends PokemonCard {
  public stage: Stage = Stage.BASIC;
  public cardType: CardType = D;
  public hp: number = 70;
  public weakness = [{ type: G }];
  public retreat = [C];

  public attacks = [
    {
      name: 'Ghostly Cries',
      cost: [C],
      damage: 0,
      text: 'For each Pokémon in your opponent\'s discard pile, put 1 damage counter on your opponent\'s Pokémon in any way you like. If you placed any damage counters in this way, your opponent shuffles all Pokémon from their discard pile into their deck.'
    },
    {
      name: 'Will-O-Wisp',
      cost: [D],
      damage: 20,
      text: ''
    }
  ];

  public regulationMark: string = 'E';
  public set: string = 'CRE';
  public setNumber: string = '103';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Spiritomb';
  public fullName: string = 'Spiritomb CRE';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Ghostly Cries
    // Ref: set-plasma-blast/uxie.ts (PUT_X_DAMAGE_COUNTERS_IN_ANY_WAY_YOU_LIKE pattern, inlined here for post-prompt shuffle)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      const pokemonCount = opponent.discard.cards.filter(c => c instanceof PokemonCard).length;
      if (pokemonCount > 0) {
        // Build damage target list for prompt
        const maxAllowedDamage: DamageMap[] = [];
        opponent.forEachPokemon(PlayerType.TOP_PLAYER, (cardList, _card, target) => {
          maxAllowedDamage.push({ target, damage: 9999 });
        });

        return store.prompt(state, new PutDamagePrompt(
          player.id,
          GameMessage.CHOOSE_POKEMON_TO_DAMAGE,
          PlayerType.TOP_PLAYER,
          [SlotType.ACTIVE, SlotType.BENCH],
          10 * pokemonCount,
          maxAllowedDamage,
          { allowCancel: false }
        ), targets => {
          const results = targets || [];
          for (const result of results) {
            const target = StateUtils.getTarget(state, player, result.target);
            const putCountersEffect = new PutCountersEffect(effect, result.damage);
            putCountersEffect.target = target;
            store.reduceEffect(state, putCountersEffect);
          }
          // After placing damage counters, shuffle all Pokemon from opponent's discard pile into their deck
          const pokemonCards = opponent.discard.cards.filter(c => c instanceof PokemonCard).slice();
          pokemonCards.forEach(c => { opponent.discard.moveCardTo(c, opponent.deck); });
          SHUFFLE_DECK(store, state, opponent);
        });
      }
    }

    return state;
  }
}
