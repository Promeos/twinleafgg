// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, SuperType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, GameError, GameMessage, PlayerType, PokemonCardList } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { ChooseCardsPrompt } from '../../game/store/prompts/choose-cards-prompt';
import { WAS_ATTACK_USED, WAS_POWER_USED, IS_ABILITY_BLOCKED, USE_ABILITY_ONCE_PER_TURN, ABILITY_USED, REMOVE_MARKER_AT_END_OF_TURN } from '../../game/store/prefabs/prefabs';
import { DISCARD_X_ENERGY_FROM_THIS_POKEMON } from '../../game/store/prefabs/costs';

export class Aegislash extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Doublade';
  public cardType: CardType = M;
  public hp: number = 150;
  public weakness = [{ type: R }];
  public resistance = [{ type: G, value: -30 }];
  public retreat = [C, C, C];

  public powers = [  {
    name: 'Stance Change',
    useWhenInPlay: true,
    powerType: PowerType.ABILITY,
    text: 'Once during your turn, you may switch this Pokémon with an Aegislash in your hand. Any attached cards, damage counters, Special Conditions, turns in play, and any other effects remain on the new Pokémon.'
  }];

  public attacks = [
    {
      name: 'Full Metal Blade',
      cost: [M, M, C],
      damage: 210,
      text: 'Discard 2 [M] Energy from this Pokémon.'
    }
  ];

  public regulationMark: string = 'E';
  public set: string = 'BST';
  public setNumber: string = '107';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Aegislash';
  public fullName: string = 'Aegislash BST';

  public readonly STANCE_CHANGE_MARKER = 'AEGISLASH_BST_STANCE_CHANGE_MARKER';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Stance Change
    // Ref: set-guardians-rising/wishiwashi.ts (Schooling - swap this Pokemon with same-name from hand)
    if (WAS_POWER_USED(effect, 0, this)) {
      const player = effect.player;

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        throw new GameError(GameMessage.BLOCKED_BY_EFFECT);
      }

      // Check if there is an Aegislash in hand
      const aegislashInHand = player.hand.cards.filter(
        c => c instanceof PokemonCard && c.name === 'Aegislash'
      );

      if (aegislashInHand.length === 0) {
        throw new GameError(GameMessage.CANNOT_USE_POWER);
      }

      USE_ABILITY_ONCE_PER_TURN(player, this.STANCE_CHANGE_MARKER, this);
      ABILITY_USED(player, this);

      // Find the PokemonCardList containing this Aegislash
      let cardList: PokemonCardList | null = null;
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (list) => {
        if (list.cards.includes(this)) {
          cardList = list;
        }
      });

      if (cardList === null) {
        return state;
      }

      const currentCardList: PokemonCardList = cardList;

      // Block non-Aegislash cards in hand
      const blocked: number[] = [];
      player.hand.cards.forEach((card, index) => {
        if (!(card instanceof PokemonCard) || card.name !== 'Aegislash') {
          blocked.push(index);
        }
      });

      store.prompt(state, new ChooseCardsPrompt(
        player,
        GameMessage.CHOOSE_CARD_TO_HAND,
        player.hand,
        { superType: SuperType.POKEMON },
        { min: 1, max: 1, allowCancel: false, blocked }
      ), selected => {
        if (!selected || selected.length === 0) {
          return;
        }

        const newAegislash = selected[0] as PokemonCard;

        // Swap: remove this card from PokemonCardList, insert new one in the same spot
        const thisIndex = currentCardList.cards.indexOf(this);
        if (thisIndex !== -1) {
          currentCardList.cards.splice(thisIndex, 1);
          const handIndex = player.hand.cards.indexOf(newAegislash);
          if (handIndex !== -1) {
            player.hand.cards.splice(handIndex, 1);
          }
          currentCardList.cards.splice(thisIndex, 0, newAegislash);
          player.hand.cards.push(this);
        }
      });
    }

    REMOVE_MARKER_AT_END_OF_TURN(effect, this.STANCE_CHANGE_MARKER, this);

    // Attack 1: Full Metal Blade
    // Ref: AGENTS-patterns.md (Discard 2 [M] Energy from this Pokemon)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      DISCARD_X_ENERGY_FROM_THIS_POKEMON(store, state, effect, 2, CardType.METAL);
    }

    return state;
  }
}
