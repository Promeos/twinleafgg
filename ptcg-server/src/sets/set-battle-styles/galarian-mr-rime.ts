// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType, SuperType, TrainerType } from '../../game/store/card/card-types';
import { StoreLike, State, GameMessage } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { WAS_ATTACK_USED } from '../../game/store/prefabs/prefabs';
import { ChooseCardsPrompt } from '../../game/store/prompts/choose-cards-prompt';
import { TrainerCard } from '../../game/store/card/trainer-card';

export class GalarianMrRime extends PokemonCard {
  public stage: Stage = Stage.STAGE_1;
  public evolvesFrom: string = 'Galarian Mr. Mime';
  public cardType: CardType = W;
  public hp: number = 110;
  public weakness = [{ type: M }];
  public retreat = [C, C];

  public attacks = [
    {
      name: 'Ball Juggling',
      cost: [C, C],
      damage: 10,
      damageCalculation: '+' as '+',
      text: 'Discard any number of Item cards that have the word "Ball" in their name from your hand. This attack does 40 more damage for each card you discarded in this way.'
    },
    {
      name: 'Frost Smash',
      cost: [W, C, C],
      damage: 80,
      text: ''
    }
  ];

  public regulationMark: string = 'E';
  public set: string = 'BST';
  public setNumber: string = '35';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Galarian Mr. Rime';
  public fullName: string = 'Galarian Mr. Rime BST';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Ball Juggling
    // Ref: set-shining-fates/ball-guy.ts (Ball regex pattern), AGENTS-patterns.md (discard from hand for damage boost)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;

      // Find all Ball Item cards in hand
      const blocked: number[] = [];
      const ballRegex = /\bBall\b/;
      player.hand.cards.forEach((card, index) => {
        if (!(card instanceof TrainerCard)
          || card.trainerType !== TrainerType.ITEM
          || !ballRegex.test(card.name)) {
          blocked.push(index);
        }
      });

      // If no Ball cards to discard, do nothing (damage stays at base 10)
      if (blocked.length === player.hand.cards.length) {
        return state;
      }

      return store.prompt(state, new ChooseCardsPrompt(
        player,
        GameMessage.CHOOSE_CARD_TO_DISCARD,
        player.hand,
        { superType: SuperType.TRAINER, trainerType: TrainerType.ITEM },
        { min: 0, max: player.hand.cards.length, allowCancel: false, blocked }
      ), selected => {
        const cards = selected || [];
        if (cards.length > 0) {
          player.hand.moveCardsTo(cards, player.discard);
          effect.damage += 40 * cards.length;
        }
      });
    }

    return state;
  }
}
