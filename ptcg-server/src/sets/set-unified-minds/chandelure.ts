// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { StoreLike, State, ConfirmPrompt, GameMessage } from '../../game';
import { Effect } from '../../game/store/effects/effect';
import { WAS_ATTACK_USED } from '../../game/store/prefabs/prefabs';

export class Chandelure extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Lampent';
  public cardType: CardType = R;
  public hp: number = 140;
  public weakness = [{ type: W }];
  public retreat = [C, C];

  public attacks = [
    {
      name: 'Spirit Burner',
      cost: [R],
      damage: 10,
      damageCalculation: '+' as '+',
      text: 'Discard the top 5 cards of your deck. This attack does 60 more damage for each Pokémon you discarded in this way. Then, put any number of Fire Pokémon you discarded in this way onto your Bench.'
    }
  ];

  public set: string = 'UNM';
  public setNumber: string = '30';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Chandelure';
  public fullName: string = 'Chandelure UNM';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Attack 1: Spirit Burner
    // Ref: set-lost-thunder/chandelure.ts (Spirit Burner pattern)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      const player = effect.player;

      // Discard top 5 cards
      const cardsToDiscard = player.deck.cards.slice(0, 5);
      const discardedPokemon: PokemonCard[] = [];

      cardsToDiscard.forEach(card => {
        player.deck.moveCardTo(card, player.discard);
        if (card instanceof PokemonCard) {
          discardedPokemon.push(card);
        }
      });

      // Add damage for each Pokemon discarded
      effect.damage += 60 * discardedPokemon.length;

      // Find Fire Pokemon among the discarded
      const firePokemon = discardedPokemon.filter(p =>
        p.cardType === CardType.FIRE && p.stage === Stage.BASIC
      );

      // Put any number of Fire Basic Pokemon onto bench
      if (firePokemon.length > 0) {
        const availableBenchSlots = player.bench.filter(b => b.cards.length === 0).length;
        if (availableBenchSlots > 0) {
          const pokemonToPlace = firePokemon.slice(0, availableBenchSlots);
          pokemonToPlace.forEach(pokemon => {
            // Ask if they want to place each one
            store.prompt(state, new ConfirmPrompt(
              player.id,
              GameMessage.WANT_TO_USE_ABILITY
            ), wantToPlace => {
              if (wantToPlace) {
                const emptySlot = player.bench.find(b => b.cards.length === 0);
                if (emptySlot) {
                  player.discard.moveCardTo(pokemon, emptySlot);
                  emptySlot.pokemonPlayedTurn = state.turn;
                }
              }
            });
          });
        }
      }
    }

    return state;
  }
}
