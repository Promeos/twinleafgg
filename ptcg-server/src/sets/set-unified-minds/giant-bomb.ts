// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { TrainerCard } from '../../game/store/card/trainer-card';
import { TrainerType } from '../../game/store/card/card-types';
import { PlayerType, StoreLike, State, StateUtils } from '../../game';
import { GamePhase } from '../../game/store/state/state';
import { AfterDamageEffect } from '../../game/store/effects/attack-effects';
import { Effect } from '../../game/store/effects/effect';
import { EndTurnEffect } from '../../game/store/effects/game-phase-effects';
import { ToolEffect } from '../../game/store/effects/play-card-effects';

export class GiantBomb extends TrainerCard {
  public trainerType: TrainerType = TrainerType.TOOL;
  public set: string = 'UNM';
  public setNumber: string = '196';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Giant Bomb';
  public fullName: string = 'Giant Bomb UNM';
  public text: string = 'If this card is attached to 1 of your Pokemon, discard it at the end of your opponent\'s turn. If the Pokemon this card is attached to is your Active Pokemon and takes 180 or more damage from an opponent\'s attack (even if this Pokemon is Knocked Out), put 10 damage counters on the Attacking Pokemon.';

  // Ref: set-stellar-crown/deluxe-bomb.ts (tool AfterDamageEffect + damage retaliation + discard), set-dragons-majesty/dragon-talon.ts (tool ToolEffect pattern)
  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Check for 180+ damage and retaliate with 10 damage counters
    if (effect instanceof AfterDamageEffect && effect.target.tools.includes(this)) {
      const player = effect.player;
      const targetPlayer = StateUtils.findOwner(state, effect.target);

      // Try to reduce ToolEffect, to check if something is blocking the tool from working
      try {
        const stub = new ToolEffect(effect.player, this);
        store.reduceEffect(state, stub);
      } catch {
        return state;
      }

      if (effect.damage <= 0 || player === targetPlayer || targetPlayer.active !== effect.target) {
        return state;
      }

      if (state.phase === GamePhase.ATTACK && effect.damage >= 180) {
        // 10 damage counters = 100 damage
        effect.source.damage += 100;
      }
    }

    // Discard at end of opponent's turn
    if (effect instanceof EndTurnEffect) {
      const player = effect.player;
      const opponent = StateUtils.getOpponent(state, player);

      // Check if this tool is attached to one of the opponent's Pokemon
      opponent.forEachPokemon(PlayerType.TOP_PLAYER, (cardList) => {
        if (cardList.tools.includes(this)) {
          cardList.moveCardTo(this, opponent.discard);
        }
      });
    }

    return state;
  }
}
