// This file was auto-generated by the card stub generator.
// Card effects were implemented by an agent.
// If you have any questions or feedback, reach out to @C4 in the discord.

import { PokemonCard } from '../../game/store/card/pokemon-card';
import { Stage, CardType } from '../../game/store/card/card-types';
import { PowerType, StoreLike, State, StateUtils, PlayerType } from '../../game';
import { DealDamageEffect } from '../../game/store/effects/attack-effects';
import { Effect } from '../../game/store/effects/effect';
import { WAS_ATTACK_USED, IS_ABILITY_BLOCKED } from '../../game/store/prefabs/prefabs';
import { DISCARD_X_ENERGY_FROM_THIS_POKEMON } from '../../game/store/prefabs/costs';

export class Solgaleo extends PokemonCard {
  public stage: Stage = Stage.STAGE_2;
  public evolvesFrom: string = 'Cosmoem';
  public cardType: CardType = M;
  public hp: number = 170;
  public weakness = [{ type: R }];
  public resistance = [{ type: P, value: -20 }];
  public retreat = [C, C, C];

  public powers = [  {
    name: 'Armor of the Sunne',
    powerType: PowerType.ABILITY,
    text: 'If you have Lunala in play, your Solgaleo and Lunala take 50 less damage from your opponent\'s attacks (after applying Weakness and Resistance). You can\'t apply more than 1 Armor of the Sunne Ability at a time.'
  }];

  public attacks = [
    {
      name: 'Sol Fangs',
      cost: [M, M, C, C],
      damage: 180,
      text: 'Discard 2 Energy from this PokÃ©mon.'
    }
  ];

  public set: string = 'CEC';
  public setNumber: string = '142';
  public cardImage: string = 'assets/cardback.png';
  public name: string = 'Solgaleo';
  public fullName: string = 'Solgaleo CEC';

  public reduceEffect(store: StoreLike, state: State, effect: Effect): State {
    // Ability: Armor of the Sunne (passive - reduce damage to Solgaleo/Lunala if Lunala in play)
    // Ref: set-hidden-fates/scizor-gx.ts (Danger Perception - passive DealDamageEffect intercept)
    if (effect instanceof DealDamageEffect && effect.target.cards.includes(this)) {
      const player = StateUtils.findOwner(state, effect.target);

      if (IS_ABILITY_BLOCKED(store, state, player, this)) {
        return state;
      }

      // Check if Lunala is in play
      let hasLunala = false;
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList) => {
        const pokemonCard = cardList.getPokemonCard();
        if (pokemonCard && pokemonCard.name === 'Lunala') {
          hasLunala = true;
        }
      });

      if (!hasLunala) {
        return state;
      }

      // Check if another Solgaleo already applied Armor of the Sunne (can't stack)
      // This is handled by checking if 'this' is the first Solgaleo with this ability in play
      let firstSolgaleoWithAbility: PokemonCard | undefined;
      player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList) => {
        const pokemonCard = cardList.getPokemonCard();
        if (pokemonCard && pokemonCard.name === 'Solgaleo' && pokemonCard instanceof Solgaleo
          && pokemonCard.powers.length > 0 && pokemonCard.powers[0].name === 'Armor of the Sunne'
          && !firstSolgaleoWithAbility) {
          firstSolgaleoWithAbility = pokemonCard;
        }
      });

      if (firstSolgaleoWithAbility !== this) {
        return state;
      }

      // Reduce damage for target if it's a Solgaleo or Lunala
      const targetPokemon = effect.target.getPokemonCard();
      if (targetPokemon && (targetPokemon.name === 'Solgaleo' || targetPokemon.name === 'Lunala')) {
        effect.damage = Math.max(0, effect.damage - 50);
      }
    }

    // Also intercept damage on other Solgaleo/Lunala from opponent's attacks
    if (effect instanceof DealDamageEffect && !effect.target.cards.includes(this)) {
      const targetPokemon = effect.target.getPokemonCard();
      if (targetPokemon && (targetPokemon.name === 'Solgaleo' || targetPokemon.name === 'Lunala')) {
        const player = StateUtils.findOwner(state, effect.target);

        // Check if this Solgaleo is in play and is the first one
        let thisIsInPlay = false;
        let firstSolgaleoWithAbility: PokemonCard | undefined;
        player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList) => {
          const pokemonCard = cardList.getPokemonCard();
          if (pokemonCard === this) {
            thisIsInPlay = true;
          }
          if (pokemonCard && pokemonCard.name === 'Solgaleo' && pokemonCard instanceof Solgaleo
            && pokemonCard.powers.length > 0 && pokemonCard.powers[0].name === 'Armor of the Sunne'
            && !firstSolgaleoWithAbility) {
            firstSolgaleoWithAbility = pokemonCard;
          }
        });

        if (!thisIsInPlay || firstSolgaleoWithAbility !== this) {
          return state;
        }

        if (IS_ABILITY_BLOCKED(store, state, player, this)) {
          return state;
        }

        // Check if Lunala is in play
        let hasLunala = false;
        player.forEachPokemon(PlayerType.BOTTOM_PLAYER, (cardList) => {
          const pokemonCard = cardList.getPokemonCard();
          if (pokemonCard && pokemonCard.name === 'Lunala') {
            hasLunala = true;
          }
        });

        if (hasLunala) {
          effect.damage = Math.max(0, effect.damage - 50);
        }
      }
    }

    // Attack 1: Sol Fangs
    // Ref: set-hidden-fates/charmeleon.ts (Flamethrower)
    if (WAS_ATTACK_USED(effect, 0, this)) {
      DISCARD_X_ENERGY_FROM_THIS_POKEMON(store, state, effect, 2);
    }

    return state;
  }
}
